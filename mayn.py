import asyncio
import openai
import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import logging

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª
BOT_TOKEN = "8104124383:AAFrGB8uZmgkRx2EGGMd_H6ldASsLaRQclw"
OPENAI_API_KEY = "YOUR_OPENAI_API_KEY"

# ØªÙ†Ø¸ÛŒÙ… OpenAI
openai.api_key = OPENAI_API_KEY

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù„Ù…Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
user_conversations = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹"""
    user_id = update.effective_user.id
    user_conversations[user_id] = []
    
    welcome_msg = """
ğŸ¤– Ø³Ù„Ø§Ù…! Ù…Ù† ÛŒÚ© Ø±Ø¨Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù‡Ø³ØªÙ…

Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†:
âœ… Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø´Ù…Ø§
âœ… Ù†ÙˆØ´ØªÙ† Ù…ØªÙ† Ùˆ Ù…Ù‚Ø§Ù„Ù‡
âœ… ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†
âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ùˆ Ú©Ø¯ Ù†ÙˆÛŒØ³ÛŒ
âœ… Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ Ø±ÛŒØ§Ø¶ÛŒ
âœ… Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ØªÙ†
âœ… Ùˆ Ø®ÛŒÙ„ÛŒ Ú†ÛŒØ²Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ù‡!

ÙÙ‚Ø· Ø³ÙˆØ§Ù„ØªÙˆÙ† Ø±Ùˆ Ø¨Ù¾Ø±Ø³ÛŒØ¯! ğŸ˜Š

Ø¯Ø³ØªÙˆØ±Ø§Øª:
/start - Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯
/clear - Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡
/help - Ø±Ø§Ù‡Ù†Ù…Ø§
    """
    
    await update.message.reply_text(welcome_msg)

async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡"""
    user_id = update.effective_user.id
    user_conversations[user_id] = []
    await update.message.reply_text("âœ… ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡ Ù¾Ø§Ú© Ø´Ø¯!")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø±Ø§Ù‡Ù†Ù…Ø§"""
    help_text = """
ğŸ”¹ **Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡:**

â€¢ ÙÙ‚Ø· Ø³ÙˆØ§Ù„ ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³ØªØªÙˆÙ† Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯
â€¢ Ù…Ù† Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù…
â€¢ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ø¯ Ø¨Ù†ÙˆÛŒØ³Ù…ØŒ ØªØ±Ø¬Ù…Ù‡ Ú©Ù†Ù…ØŒ Ù…Ø³Ø§Ø¦Ù„ Ø­Ù„ Ú©Ù†Ù…
â€¢ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±Ùˆ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ù…

ğŸ”¹ **Ø¯Ø³ØªÙˆØ±Ø§Øª:**
/start - Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯
/clear - Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
/help - Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§

ğŸ’¡ **Ù†Ú©ØªÙ‡:** Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ù†ØªÛŒØ¬Ù‡ØŒ Ø³ÙˆØ§Ù„ØªÙˆÙ† Ø±Ùˆ ÙˆØ§Ø¶Ø­ Ø¨Ù¾Ø±Ø³ÛŒØ¯!
    """
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def get_ai_response(user_message, conversation_history):
    """Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² OpenAI"""
    try:
        # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù„Ù…Ù‡
        messages = [
            {"role": "system", "content": "Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù…ÙÛŒØ¯ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ù‡Ø³ØªÛŒØ¯. Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯. Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ùˆ Ø¯Ù‚ÛŒÙ‚ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯."}
        ]
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡
        for msg in conversation_history:
            messages.append(msg)
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø±
        messages.append({"role": "user", "content": user_message})
        
        # Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ OpenAI
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",  # ÛŒØ§ gpt-4 Ø§Ú¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±ÛŒØ¯
            messages=messages,
            max_tokens=2000,
            temperature=0.7,
            frequency_penalty=0.0,
            presence_penalty=0.0
        )
        
        return response.choices[0].message.content.strip()
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² OpenAI: {e}")
        return "âŒ Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±"""
    user_id = update.effective_user.id
    user_message = update.message.text
    
    # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª
    if user_id not in user_conversations:
        user_conversations[user_id] = []
    
    # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾..."
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    
    try:
        # Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² AI
        ai_response = await get_ai_response(user_message, user_conversations[user_id])
        
        # Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡
        user_conversations[user_id].append({"role": "user", "content": user_message})
        user_conversations[user_id].append({"role": "assistant", "content": ai_response})
        
        # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ 20 Ù¾ÛŒØ§Ù… Ø¢Ø®Ø±
        if len(user_conversations[user_id]) > 20:
            user_conversations[user_id] = user_conversations[user_id][-20:]
        
        # Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®
        if len(ai_response) > 4000:
            # ØªÙ‚Ø³ÛŒÙ… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ
            chunks = [ai_response[i:i+4000] for i in range(0, len(ai_response), 4000)]
            for chunk in chunks:
                await update.message.reply_text(chunk)
        else:
            await update.message.reply_text(ai_response)
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…: {e}")
        await update.message.reply_text("âŒ Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§"""
    logger.error(f"Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯: {context.error}")

def main():
    """Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª"""
    # Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
    if BOT_TOKEN == "YOUR_TELEGRAM_BOT_TOKEN":
        print("âŒ Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!")
        return
    
    if OPENAI_API_KEY == "YOUR_OPENAI_API_KEY":
        print("âŒ Ù„Ø·ÙØ§Ù‹ API Key OpenAI Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!")
        return
    
    # Ø³Ø§Ø®Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("clear", clear_history))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† error handler
    application.add_error_handler(error_handler)
    
    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª
    print("ğŸ¤– Ø±Ø¨Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯...")
    print("âœ… Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…!")
    
    application.run_polling()

if __name__ == '__main__':
    main()


